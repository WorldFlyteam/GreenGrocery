@{
    Page.Title = "Меню сайта";
    var IsValid = true;
    var errorm = "";
    var itemid = Request["id"];
    if(itemid == null || itemid.IsEmpty()){
        Response.SetStatus(HttpStatusCode.BadRequest);
    }

    var linklabelvalid = true;
    var pagelinkvalid = true;
    var linklabel = Request["linklabel"];
    var pagelink = Request["pagelink"];
    var linkorder = Request["linkorder"]; 
    var hashcode = Request.GetHashCode();

    var db = Database.Open("Datebase");
    var data = db.QuerySingle("select * from SiteMenu where Id = @0", itemid);
    var dataforgrid = db.Query("select * from SiteMenu order by OrderId DESC");
    var grid = new WebGrid(dataforgrid);
    

    if(IsPost){
        AntiForgery.Validate();
        linklabel = Request["linklabel"];
        if(linklabel.IsEmpty()){
            linklabelvalid = true;
            IsValid = false;
        }

        pagelink = Request["pagelink"];
        if(pagelink.IsEmpty()){
            pagelinkvalid = true;
            IsValid = false;
        }
    

         var target = Request["Target"];

        linkorder = Request["linkorder"];
        if(linkorder.IsEmpty()){
            linkorder = "1";
        }

            if(IsValid){
                try
                    {
                    //db.Execute("INSERT INTO SiteMenu (Label, Link, Target, OrderId) VALUES (@0, @1, @2, @3)", linklabel, pagelink, target, linkorder);
                    db.Execute("UPDATE SiteMenu SET Label = @0, Link = @1, Target = @2, OrderId = @3 WHERE Id = @4", linklabel, pagelink, target, linkorder, itemid);
                    Response.Redirect("~/Components/Control/SiteMenu");
                    }
                catch (Exception ex)
                {            
                    errorm = ex.Message.ToString();
                }
           }
    }
}

@errorm
<a href="SiteMenu#add"><h2 class="add-onedit" id="add">Добавление пункта меню</h2></a>
<h2 id="edit">Редактирование пунктов меню</h2>
<form action="@Request.Url" name="add" method="post">
    @AntiForgery.GetHtml()
    <table>
        <tbody>
            <tr>
                <td class="table-label">
                    <label for="linklabel">Название пункта меню*:</label>
                </td>
                <td>
                    <input type="text" class="input" id="linklabel" name="linklabel" value="@data.Label"/>
            @if(!linklabelvalid){
                <text>
                    <span class="form-error">
                        Текст ссылки не может быть пустым
                    </span>
                </text>
            }
                </td>
            </tr>
            <tr>
                <td class="table-label">
                    <label for="pagelink">Адрес ссылки*:</label>
                </td>
                <td>
                    <input type="text" class="input" id="pagelink" name="pagelink" value="@data.Link" maxlength="250" />
                 
                @if(!pagelinkvalid){
                <text>
                    <span class="form-error">
                        Ссылка должна куда-то вести
                    </span>
                </text>
            }
                </td>
            </tr>
        <tr>
                <td class="table-label">
                    <label for="Target">Target:</label>
                </td>
                <td>
                    <select id="Target" name="Target">
                      <option @if(data.Target == "_self"){<text>selected</text>} value="_self">Тоже окно</option>
                      <option  @if(data.Target == "_blank"){<text>selected</text>} value="_blank">Новое окно</option>
                  </select>
                </td>
            </tr>
        <tr>
                <td class="table-label">
                    <label for="linkorder">Номер пункта меню:</label>
                </td>
                <td>
                    <input type="number" maxlength="32" class="input" id="linkorder" name="linkorder" value="@data.OrderId"/>
                </td>
            </tr>
        <tr>
                <td class="table-label">
                    <input type="submit" class="btn" value="Сохранить"/>
                </td>
                
            </tr>
        </tbody>
    </table>
</form>


<h2 id="avalible">Доступные пункты меню</h2>
@grid.GetHtml(tableStyle: "Grid",
                headerStyle: "grid-head",
                //alternatingRowStyle: "grid-alt", 
                columns:grid.Columns(
                grid.Column(format: @<a href="SiteMenuEdit?id=@item.Id"  class="grid-ctrl-ico grid-con" title="Редактирование" >✏</a>),
                    grid.Column("Label", "Имя пункта", style: "grid-GB"), 
                    grid.Column("Link", "Ссылка", format:@<i>@item.Link</i>),
                    grid.Column("Order", "Номер",format:@<span class="grid-GB"><a href="SiteMenuChangeOrderId.cshtml?tn=rc_simplemenu&cv=1&id=@item.Id" class="grid-ctrl-ico grid-con" title="Повысить">↑</a>
                    <a href="SiteMenuChangeOrderId.cshtml?tn=rc_simplemenu&cv=-1&id=@item.Id" class="grid-ctrl-ico grid-con" title="Понизить">↓</a>@item.OrderId</span>),
                    grid.Column("Target", "Target"),
                    grid.Column(format:@<a onclick="itemdel(@hashcode, @item.Id)" class="grid-ctrl-ico grid-del" title="Удаление">☓</a>)
                                    )
                            )


<script>function itemdel(t,id){confirm('Вы уверены, что хотите удалить?');if(t == @hashcode){window.location = "SiteMenu.cshtml?DeleteMenuItem=true&ItemId=" + id + "&hash=" + @hashcode;}return false;}</script>