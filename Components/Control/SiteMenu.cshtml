@{
    
Page.Title = "Меню сайта";    
var errorm = "";
var IsValid = true;
var linklabelvalid = false;
var pagelinkvalid = false;
var linklabel = Request["linklabel"];
var pagelink = Request["pagelink"];
var linkorder = Request["linkorder"]; 
var hashcode = Request.GetHashCode();   


    var db = Database.Open("Datebase");

    var deletepage = Request["deletemenuitem"];
    if(deletepage == "true"){
        
        var deleteitemid = Request["itemid"];
        
        
            db.Execute("delete from SiteMenu where Id=@0", deleteitemid);
            
        
        Response.Redirect("SiteMenu");
    }


    var data = db.Query("select * from SiteMenu order by OrderId DESC");
    var grid = new WebGrid(data);
    
    var pages = db.Query("Select Name from Pages order by Name");



    if(IsPost){
        AntiForgery.Validate();
        linklabel = Request["linklabel"];
        if(linklabel.IsEmpty()){
            linklabelvalid = true;
            IsValid = false;
        }

        pagelink = Request["pagelink"];
        if(pagelink.IsEmpty()){
            pagelinkvalid = true;
            IsValid = false;
        }
    

         var target = Request["Target"];

        linkorder = Request["linkorder"];
        if(linkorder.IsEmpty()){
            linkorder = "1";
        }

            if(IsValid){
                try
                    {
                    db.Execute("INSERT INTO SiteMenu (Label, Link, Target, OrderId) VALUES (@0, @1, @2, @3)", linklabel, pagelink, target, linkorder);
                    Response.Redirect("~/Components/Control/SiteMenu");
                    }
                catch (Exception ex)
                {
            
                    errorm = ex.Message.ToString();
                }
           }


   }

    
}
@errorm
<h2>Добавление пункта меню</h2>
<form action="@Request.Url"  method="post">
    @AntiForgery.GetHtml()
    <ol>
        <li>
            <label for="linklabel">Название пункта меню*:</label>
            <input type="text" name="linklabel" value="@linklabel"/>
            @if(linklabelvalid){
                <text>
                    <span class="form-error">
                        Текст ссылки не может быть пустым
                    </span>
                </text>
            }
        </li>
       @* <li >
                <label for="pagelink">Select Page:</label>
                 <select name="pagelink">
                 @foreach (var row in pages)
                 {
                      <option value="@row.Name">@row.Name</option>
                 }
                    
                 </select>
             </li>*@
             <li >
                <label for="pagelink">Адрес ссылки*:</label>
                <input type="text" name="pagelink" value="@pagelink" maxlength="250" />
                 
                 @if(pagelinkvalid){
                <text>
                    <span class="form-error">
                        Ссылка должна куда-то вести
                    </span>
                </text>
            }
             </li>
        <li >
                <label for="Target">Target:</label>
                  <select name="Target">
                      <option value="_self">Same window</option>
                      <option value="_blank">New window</option>
                  </select>
             </li>
        <li>
            <label for="linkorder">Номер пункта меню:</label>
            <input type="number" name="linkorder" value="@linkorder"/>
           
        </li>
        <li>
            <input type="submit" class="btn" value="Добавить"/>
        </li>
    </ol>
</form>

<h2>Доступные пункты меню</h2>
@grid.GetHtml(tableStyle: "Grid",
                headerStyle: "grid-head",
                //alternatingRowStyle: "grid-alt", 
                columns:grid.Columns(
                    grid.Column("Label", "Имя пункта", style: "grid-GB"), 
                    grid.Column("Ссылка", format:@<i>@item.Link</i>),
                    grid.Column("Номер",format:@<span class="grid-GB"><a href="SiteMenuChangeOrderId.cshtml?tn=rc_simplemenu&cv=1&id=@item.Id" class="grid-ctrl-ico grid-con">↑</a>
                    <a href="SiteMenuChangeOrderId.cshtml?tn=rc_simplemenu&cv=-1&id=@item.Id" class="grid-ctrl-ico grid-con">↓</a>@item.OrderId</span>),
                    grid.Column("Target", "Target"),
                    grid.Column(format:@<a onclick="itemdel(@hashcode, @item.Id)" class="grid-ctrl-ico grid-del" onclick="return confirm('Вы уверены, что хотите удалить?')" title="Удаление">☓</a>)
                                    )
                            )

